{% extends "base.html" %}

{% block head %}
{{ block.super }}
<style type="text/css" media="all">
    #title
    {
		font-family:arial;
    }

    #picked_sounds
    {
		font-family:arial;
        width: 500px;
        overflow: hidden;
        float:right;
        padding: 0px;

    }
    
    #picked_sounds_menu
    {
		font-family:arial;
        width: 500px;
        overflow: hidden;
        border: 0px solid black;
        float:right;
        padding: 5px;
        position: fixed;
        left:600px;
        top:25px;
        background-color:rgb(235,235,235);
    }
    

    #picked_sounds .add
    {
        display: none;
    }

    #picked_sounds .remove
    {
        display: inline;
    }
    
    
    #search-results
    {
 		font-family:arial;
        width: 500px;
        overflow: hidden;
        border: 0px solid black;
        float:left;
        padding: 5px;
    }

    #search-results .add
    {
        display: inline;
    }

    #search-results .remove
    {
        display: none;
    }
    
 	.alignRight
 	{
 		font-family:arial;
 		text-align: right;
 	}
      
  	.search_resultE { 
  		font-family:arial; 
  		font-size: 10pt; 
  		background-color:rgb(255,255,255);
	}
 
	.search_resultE:hover{
		font-family:arial;
		background-color:rgb(200,255,200);
		font-size: 10pt; 
	}	

	.search_resultO { 
  		font-family:arial; 
  		font-size: 10pt; 
  		background-color:rgb(235,235,235);
	}
 
	.search_resultO:hover{
		font-family:arial;
		background-color:rgb(200,255,200);
		font-size: 10pt; 
	}
	
	.picked_result { 
  		font-family:arial; 
  		font-size: 10pt; 
	}
	
	.picked_result:hover { 
  		font-family:arial; 
  		font-size: 10pt; 
  		background-color:rgb(255,200,200);
	}
	
	
	.space {		
		height: 20pt; 
	}
	


</style>
<script type="text/javascript">
    var sounds = [];
	var num_sounds = 0;
	var max_sounds = 5;
	var currently_displayed_search_result = 0;
	// var username = {{ username }};
	var freesound;
	
	$(document).ready(function(){
	
	
	$("#id_sound_ids").hide();
	$("#id_sound_ids").prev().hide();
	$("#send_form").hide();
	$("#remove_sounds_label").hide();
	
	apiKey = settings.apiKey;	
	console.debug("key: " + apiKey);
	
	if(apiKey == "")
	{
		alert("no KEY no honey!"); 
	}			
	else 
	{				
		/*======= freesound object ========*/
		//creating freesound object	
		freesound = new Freesound(apiKey, true);
	}
	});
	
	function search_sounds() {
		if ($("#search-q").length > 0) {
			console.log("query: " + $("#search-q").val());
			var q = $("#search-q").val();
			var p = 1;
			var f = "duration:[0.1 TO 10.0]";
			var s = "downloads_desc";
			freesound.getSoundsFromQuery(q,p,f,s,displaySearchResults, errorSearch);
			
		}
	}
	function displaySearchResults(soundCollection) {
		currently_displayed_search_result = 0;
		
		$("#search-results").text("")
		$("#search-results").append("<div class=space>Click over sounds to add to your team</div>")
		//$("#search-results").append("<br>* number of results: " + soundCollection.properties['num_results']);
		//$("#search-results").append("<br>* number of pages: " + soundCollection.properties['num_pages']);
		//$("#search-results").append("<br>* sounds:");
		for (obj in soundCollection.properties['sounds']) {
			//sound_id = soundCollection.properties['sounds'][obj]['id'];
			// $("#search-results").append("<br>--- " + obj + ": " + sound_id + " - " + soundCollection.properties['sounds'][obj]['original_filename']);
			freesound.getSound(soundCollection.properties['sounds'][obj]['id'], displaySoundInfo, errorSound );	
		}
		 
		sc = soundCollection;
		// $("#respSearch").append('<br><br><button onclick="sc.previous(displaySearchResults);">previous</button><button onclick="sc.next(displaySearchResults);">next</button>')
	}
	function displaySoundInfo(sound) {
		// console.log("displaySoundInfo");
		console.log(sound.properties['id']);
		
		currently_displayed_search_result = currently_displayed_search_result + 1;
		if ((currently_displayed_search_result % 2) == 1){
			classEO='search_resultE';
		}else{
			classEO='search_resultO';
		} 
		
		$("#search-results").append("<div class='" + classEO + "' id=" + sound.properties['id'] + " onclick='addSound(this," + sound.properties['id'] + ")'\>"); 
		
		$("#"+sound.properties['id']).append(
		'<table><tr><td><img src="'+ sound.properties['waveform_m'] + '" alt = "' + sound.properties['waveform_m'] + '"/></td><td valign=top> - filename: "' + sound.properties['original_filename'] + '" <br>- tags: "' + sound.properties['tags'] + '" </td></tr></table>'
		)
		
		// TODO: make sounds able to play
		/*
		snd = new Audio(sound.properties['preview-hq-mp3']);
		$("#"+sound.properties['id']).append('<br><button onclick="snd.play()">play</button><button onclick="snd.pause()">pause</button>')
		*/
		//$("#"+sound.properties['id']).append("</td></tr></table>");
		$("#search-results").append("</div>");
		
	}
	function errorSearch() {
	}
	function errorSound() {
	}

    function addSound(element, soundId)
    {
    	$("#send_form").show();
    	$("#remove_sounds_label").show();
        
        if (num_sounds < max_sounds) 
        {
            console.log(num_sounds);
	        if ($.inArray(soundId, sounds) == -1 && num_sounds <= max_sounds)
	        {
		        num_sounds = num_sounds + 1;  
	            console.log("addSound");
	            sounds.push(soundId);
	            $("#id_sound_ids").attr("value", sounds);//.attr("value", str(sounds)); // TODO:
				// TODO: change id and remove onclick handler
	            $(element).closest("#search-results > div").clone()            								
	            								.attr({
	            								id: soundId+"_choose",
	            								"class": "picked_result"							
	            								}).appendTo("#picked_sounds");
	            
	            $("#"+soundId+"_choose").removeAttr('onclick').click( function () { removeSound($("#"+soundId+"_choose"), soundId); return false} )
	                     
	        }
        }
        else {
            alert("Reached your max sounds, don't be greedy warrior!!!");
        }
    }

    function removeSound(element, soundId)
    {
    	console.log("removing sound: " + soundId)
        var index = $.inArray(soundId, sounds);
        // $(element).prev().attr("id)
        if (index != -1)
        {

            sounds.splice(index, 1);
			$("#id_sound_ids").attr("value", sounds);
            $(element).closest("#picked_sounds > div").remove();
            num_sounds = num_sounds - 1;
            
            if (num_sounds <= 0){
            	num_sounds = 0;
            	$("#send_form").hide();
            	$("#remove_sounds_label").hide();
            }
			
			
            
        }
    }
</script>
{% endblock head %}

{% block title %}Pick your sounds...{% endblock title %}

{% block content %}

<h2 id="title">Search sounds</h2>
<p>
</p>

<div id="search-div">
    <p>
    	<input type="text" name="q" id="search-q" size="45" /> 
    	<!-- <input type="submit" name="submit" value="search sounds" onclick="search_sounds" id="search-button"/> -->
    	<button onclick="search_sounds()">Get!</button>
    </p>
</div>

<div id="search-results" class="sound_list_minimal">
    
</div>

<div id="picked_sounds_menu">
<div id="picked_sounds" class="sound_list_minimal">
    <h2>War files</h2>
    <div>
        <div id="remove_sounds_label"class="space">
            Click over sounds to remove from your team
        </div>
    </div>    
</div>
<div>
	<form id="send_form" action="." method="POST">{% csrf_token %}
        {{ form.as_p }}
        <div class="alignRight">
        <input class="alignRight" type="submit" value="I'm ready to play!" halign="right">
        </div>
 	</form>
</div>
</div>

 
{% endblock content %}